{
  "title": "Auto-mana partial payment silently cancels spell with no LLM feedback",
  "description": "When auto-mana pays part of a spell's cost but can't complete payment (no remaining sources to tap, no pool mana), the remaining payment is stored as a pending GAME_PLAY_MANA action. The LLM doesn't know this — it already submitted its next action (pass_priority) thinking the spell was on the stack. The pending mana payment gets cancelled by the auto-pass loop or by the pass_priority consuming it, silently undoing the cast. The LLM receives no feedback and hallucinates that the spell resolved.\n\nIn this game, Gem25F Spike (gemini-2.5-flash) cast Three Steps Ahead ({2}{U}) with only 2 lands (Island + Hallowed Fountain). The auto-mana system tapped both lands for {U} and {1}, but couldn't find a source for the remaining {1}. It logged \"no auto source available, waiting for manual choice\" and stored the GAME_PLAY_MANA as a pending action. The LLM's pass_priority call was consumed by the pending action, cancelling the spell. The LLM then said \"I drew two cards and discarded one\" — completely hallucinated, since Three Steps Ahead never resolved (it remained in hand at 7 cards).\n\nThe LLM operated on incorrect game state for the rest of the game, believing it had drawn cards it hadn't.\n\nRelated: #225 fixed the case where the LLM sees the mana prompt and sends answer=true (choose_action path). This issue is the passPriority() path — the pending GAME_PLAY_MANA is silently cancelled inside the passPriority() loop (line 1774) before the LLM ever sees it.\n\nEvidence:\n- ~/mage-bench-logs/game_20260211_163227/Gem25F Spike_pilot.log lines 300-308: auto-mana logs, pass_priority, then hallucinated resolution\n- ~/mage-bench-logs/game_20260211_163227/Gem25F Spike_bridge.jsonl: 3 GAME_PLAY_MANA at 16:36:05-06, then GAME_SELECT at 16:36:06 (spell cancelled)\n- Game state at 16:36:08: 7 cards in hand including Three Steps Ahead (still there = never cast)\n\nSource: BridgeCallbackHandler.java:2652-2662 — when handleGamePlayManaAuto() returns false in MCP mode, storePendingAction() is called. The pending action is then cancelled by the auto-pass loop (lines 1761-1775) or by the LLM's next tool call.\n\nSuggested fix: When handleGamePlayManaAuto() can't find any source AND there's no usable pool mana, auto-cancel immediately (sendPlayerBoolean(false)) instead of storing a pending action. Also inject an informational message to the LLM: \"Spell cancelled — not enough mana to complete payment.\" This matches the non-MCP mode behavior (line 2658) and prevents the LLM from hallucinating spell resolution. Add the spell to failedManaCasts to prevent retry loops.",
  "status": "open",
  "priority": 2,
  "type": "bug",
  "labels": ["headless-client"],
  "created_at": "2026-02-11T17:00:00.000000-08:00",
  "updated_at": "2026-02-11T17:00:00.000000-08:00"
}
