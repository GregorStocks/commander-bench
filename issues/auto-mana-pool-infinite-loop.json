{
  "title": "Auto-mana pool payment loop has no circuit breaker, causes 37-minute game hang",
  "description": "handleGamePlayManaAuto() can enter an infinite loop when spending mana from the pool. When sendPlayerManaType() fires but the payment never actually completes (XMage keeps re-sending GAME_PLAY_MANA), the function calls sendPlayerManaType() again with the same pool mana type, ~10 times per second, indefinitely.\n\nThe existing interactionsThisTurn circuit breaker (max 25) doesn't help because it's only checked inside chooseAction(). Since handleGamePlayManaAuto() returns true after sending pool mana, the callback never reaches chooseAction() — the counter never increments.\n\nIn this game, Haiku Analyst cast Consult the Star Charts with kicker. During mana payment, a GAME_CHOOSE_ABILITY prompt for Floodfarm Verge was mishandled (see issue mana-ability-auto-choose). After the pilot recovered and some lands were tapped, the remaining {1} generic payment entered the pool path. getPoolManaChoices() kept returning blue mana, sendPlayerManaType() kept sending it, but XMage never accepted the payment as complete. 20,783 GAME_PLAY_MANA callbacks were logged over 37 minutes before the game was manually killed.\n\nEvidence:\n- ~/mage-bench-logs/game_20260211_091712/Haiku Analyst_bridge.jsonl: 20,783 GAME_PLAY_MANA events from 09:24 to 10:00\n- ~/mage-bench-logs/game_20260211_091712/Haiku Analyst_errors.log: initial GAME_CHOOSE_ABILITY errors at 09:23:59, stall detections at 09:33:32 and 09:39:02\n- ~/mage-bench-logs/game_20260211_091712/game_events.jsonl: 37 minutes of stall, game terminated by spectator window close\n\nSource: BridgeCallbackHandler.java:3229-3246 — the pool mana payment path in handleGamePlayManaAuto(). Returns true after sendPlayerManaType() with no tracking of consecutive attempts.\n\nSuggested fix: Add a counter for consecutive pool-mana payments for the same spell. Track (payingForId, attemptCount) — increment each time pool mana is sent for the same payingForId. After a threshold (e.g., 10 attempts), cancel the payment (sendPlayerBoolean(false), add to failedManaCasts) instead of retrying. Reset the counter when payingForId changes or a tappable source is found. This mirrors the existing failedManaCasts pattern but catches the pool-mana case that currently slips through.",
  "status": "open",
  "priority": 1,
  "type": "bug",
  "labels": ["headless-client"],
  "created_at": "2026-02-11T10:31:24.000000-08:00",
  "updated_at": "2026-02-11T10:31:24.000000-08:00"
}
