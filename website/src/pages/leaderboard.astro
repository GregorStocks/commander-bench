---
import Base from '../layouts/Base.astro';
import benchmarkData from '../data/benchmark-results.json';

const FORMAT_LABELS: Record<string, string> = {
  combined: 'Combined',
  standard: 'Standard',
  modern: 'Modern',
  legacy: 'Legacy',
};

const FORMAT_ORDER = ['combined', 'standard', 'modern', 'legacy'];

// Build per-format data from the formats key (or fall back to single leaderboard)
const formats: Record<string, any> = (benchmarkData as any).formats ?? {
  combined: { totalGames: benchmarkData.totalGames, models: benchmarkData.models },
};

// Only show tabs for formats that have games (or combined)
const activeFormats = FORMAT_ORDER.filter(
  (f) => f === 'combined' || (formats[f] && formats[f].totalGames > 0)
);

// Collect all providers across all formats for the filter dropdown
const allProviders = [
  ...new Set(
    Object.values(formats)
      .flatMap((f: any) => (f.models || []).map((m: any) => m.provider))
  ),
].sort();

const hasData = benchmarkData.models.length > 0 || Object.keys(formats).length > 1;
const excludedGames = (benchmarkData as any).excludedGames ?? 0;
const minEpoch = (benchmarkData as any).minEpoch ?? null;
---

<Base title="Leaderboard">
  <h1>Leaderboard</h1>

  {hasData ? (
    <p class="subtitle" id="subtitle">
      Model ratings based on {benchmarkData.totalGames.toLocaleString()} games.
      {excludedGames > 0 && (
        <span class="excluded-note">({excludedGames} older {excludedGames === 1 ? 'game' : 'games'} excluded)</span>
      )}
      Last updated: <time>{new Date(benchmarkData.generatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</time>.
    </p>

    <div class="format-tabs" id="format-tabs" style={activeFormats.length <= 1 ? 'display:none' : ''}>
      {activeFormats.map((fmt: string) => (
        <button class:list={['format-tab', { active: fmt === 'combined' }]} data-format={fmt}>
          {FORMAT_LABELS[fmt] || fmt}
          {formats[fmt] && fmt !== 'combined' ? (
            <span class="tab-count">({formats[fmt].totalGames})</span>
          ) : null}
        </button>
      ))}
    </div>

    <details class="rating-info">
      <summary>How ratings work</summary>
      <div class="rating-info-body">
        <p>
          Ratings use the <a href="https://en.wikipedia.org/wiki/Elo_rating_system" target="_blank" rel="noopener">Elo</a>
          rating system with K-factor 32. Each model starts at <strong>1600</strong>.
          After each game, the winner gains points and the loser loses points based on
          the expected outcome â€” an upset yields a bigger swing.
        </p>
        <p>
          The <strong>Combined</strong> leaderboard rates all 1v1 format games
          (Standard, Modern, Legacy) in a single unified rating pool.
        </p>
        {minEpoch && excludedGames > 0 && (
          <p>
            {excludedGames} older {excludedGames === 1 ? 'game is' : 'games are'} excluded
            from ratings. The evaluation harness has improved over time, so games played on
            early versions aren't representative of current model quality.
          </p>
        )}
      </div>
    </details>

    <div class="filters">
      <input
        type="text"
        id="search-input"
        placeholder="Search model name..."
        autocomplete="off"
      />
      <select id="provider-filter">
        <option value="">All Providers</option>
        {allProviders.map((p: string) => (
          <option value={p}>{p}</option>
        ))}
      </select>
    </div>

    <div class="table-wrap">
      <table id="leaderboard-table" class="format-combined">
        <thead>
          <tr>
            <th class="rank-col">#</th>
            <th data-sort="modelName" data-type="string">Model Name</th>
            <th data-sort="provider" data-type="string">Provider</th>
            <th data-sort="rating" data-type="number" class="sorted desc">Rating <span class="sort-arrow">&#9660;</span></th>
            <th data-sort="gamesPlayed" data-type="number">Games Played</th>
            <th data-sort="winRate" data-type="number" class="col-winrate">Win Rate</th>
            <th data-sort="avgBlundersPerGame" data-type="number">Blunders/Game</th>
            <th data-sort="avgApiCost" data-type="number">Avg Cost</th>
          </tr>
        </thead>
        {activeFormats.map((fmt: string) => (
          <tbody data-format={fmt} style={fmt !== 'combined' ? 'display: none;' : ''}>
            {(formats[fmt]?.models || []).map((m: any, i: number) => (
              <tr
                data-model-name={m.modelName.toLowerCase()}
                data-model-id={m.modelId}
                data-reasoning-effort={m.reasoningEffort || ''}
                data-provider={m.provider}
                data-rating={m.rating}
                data-games-played={m.gamesPlayed}
                data-win-rate={m.winRate}
                data-avg-blunders-per-game={m.avgBlundersPerGame ?? 0}
                data-avg-api-cost={m.avgApiCost}
              >
                <td class="rank-cell">{i + 1}</td>
                <td class="model-name">{m.modelName}</td>
                <td>{m.provider}</td>
                <td class="num">{m.rating}</td>
                <td class="num"><a class="games-link" href={`/games?model=${encodeURIComponent(m.modelId)}`}>{m.gamesPlayed}</a></td>
                <td class="num col-winrate">{(m.winRate * 100).toFixed(1)}%</td>
                <td class="num">{(m.avgBlundersPerGame ?? 0).toFixed(1)}</td>
                <td class="num">${m.avgApiCost.toFixed(2)}</td>
              </tr>
            ))}
          </tbody>
        ))}
      </table>
    </div>

    <p class="no-results" id="no-results" style="display: none;">
      No models match your filters.
    </p>
  ) : (
    <p class="empty-state">No games have been played yet. Check back soon!</p>
  )}
</Base>

<script>
  const table = document.getElementById('leaderboard-table') as HTMLTableElement | null;
  if (!table) {
    // No data yet, nothing to make interactive
  } else {
  const headers = table.querySelectorAll('th[data-sort]');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const providerFilter = document.getElementById('provider-filter') as HTMLSelectElement;
  const noResults = document.getElementById('no-results')!;
  const formatTabs = document.getElementById('format-tabs');

  let activeFormat = 'combined';

  function getActiveTbody(): HTMLTableSectionElement {
    return table!.querySelector(`tbody[data-format="${activeFormat}"]`) as HTMLTableSectionElement;
  }

  function updateGamesLinks() {
    table!.querySelectorAll('tr[data-model-id]').forEach((row) => {
      const el = row as HTMLElement;
      const modelId = el.dataset.modelId!;
      const effort = el.dataset.reasoningEffort;
      const link = el.querySelector('a.games-link') as HTMLAnchorElement | null;
      if (!link) return;
      const params = new URLSearchParams({ model: modelId });
      if (effort) params.set('effort', effort);
      if (activeFormat !== 'combined') params.set('format', activeFormat);
      link.href = '/games?' + params.toString();
    });
  }

  // Format tab switching
  if (formatTabs) {
    formatTabs.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.format-tab') as HTMLElement | null;
      if (!btn) return;
      const fmt = btn.dataset.format!;
      if (fmt === activeFormat) return;

      // Hide all tbodies, show selected
      table!.querySelectorAll('tbody[data-format]').forEach((tb) => {
        (tb as HTMLElement).style.display = 'none';
      });
      const newTbody = table!.querySelector(`tbody[data-format="${fmt}"]`) as HTMLElement;
      if (newTbody) newTbody.style.display = '';

      // Update active tab styling
      formatTabs.querySelectorAll('.format-tab').forEach((t) => t.classList.remove('active'));
      btn.classList.add('active');

      activeFormat = fmt;
      table!.classList.toggle('format-combined', fmt === 'combined');
      updateGamesLinks();
      applyFilters();
    });
  }

  function sortTable(column: string, type: string, ascending: boolean) {
    const tbody = getActiveTbody();
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
      const elA = a as HTMLElement;
      const elB = b as HTMLElement;
      let valA: string | number;
      let valB: string | number;

      if (type === 'number') {
        valA = parseFloat(elA.dataset[column] ?? '0');
        valB = parseFloat(elB.dataset[column] ?? '0');
      } else {
        valA = (elA.dataset[column] ?? '').toLowerCase();
        valB = (elB.dataset[column] ?? '').toLowerCase();
      }

      if (valA < valB) return ascending ? -1 : 1;
      if (valA > valB) return ascending ? 1 : -1;
      return 0;
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  headers.forEach(th => {
    th.addEventListener('click', () => {
      const el = th as HTMLElement;
      const column = el.dataset.sort!;
      const type = el.dataset.type!;

      const wasSorted = th.classList.contains('sorted');
      const wasAsc = th.classList.contains('asc');
      const ascending = wasSorted ? !wasAsc : (type === 'string');

      headers.forEach(h => {
        h.classList.remove('sorted', 'asc', 'desc');
        const arrow = h.querySelector('.sort-arrow');
        if (arrow) arrow.textContent = '';
      });

      th.classList.add('sorted', ascending ? 'asc' : 'desc');
      let arrow = th.querySelector('.sort-arrow');
      if (!arrow) {
        arrow = document.createElement('span');
        arrow.className = 'sort-arrow';
        th.appendChild(arrow);
      }
      arrow.textContent = ascending ? '\u25B2' : '\u25BC';

      sortTable(column, type, ascending);
      updateRanks();
    });
  });

  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const provider = providerFilter.value;
    const tbody = getActiveTbody();
    if (!tbody) return;
    const rows = tbody.querySelectorAll('tr');
    let visibleCount = 0;

    rows.forEach(row => {
      const el = row as HTMLElement;
      const matchesSearch = !searchTerm || (el.dataset.modelName ?? '').includes(searchTerm);
      const matchesProvider = !provider || el.dataset.provider === provider;
      const visible = matchesSearch && matchesProvider;

      el.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    noResults.style.display = visibleCount === 0 ? '' : 'none';
    updateRanks();
  }

  function updateRanks() {
    const tbody = getActiveTbody();
    if (!tbody) return;
    let rank = 1;
    tbody.querySelectorAll('tr').forEach(row => {
      const el = row as HTMLElement;
      const rankCell = el.querySelector('.rank-cell');
      if (!rankCell) return;
      if (el.style.display === 'none') {
        rankCell.textContent = '';
      } else {
        rankCell.textContent = String(rank++);
      }
    });
  }

  searchInput.addEventListener('input', applyFilters);
  providerFilter.addEventListener('change', applyFilters);
  }
</script>

<style>
  h1 {
    color: #e94560;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: #a0a0b8;
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
    line-height: 1.7;
  }

  .subtitle time {
    color: #e0e0e0;
  }

  .excluded-note {
    color: #fbbf24;
    font-size: 0.85rem;
  }

  .format-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .format-tab {
    font-family: inherit;
    font-size: 0.85rem;
    padding: 0.4rem 0.9rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 20px;
    color: #a0a0b8;
    cursor: pointer;
    transition: all 0.2s;
  }

  .format-tab:hover {
    border-color: #e94560;
    color: #e0e0e0;
  }

  .format-tab.active {
    background: #e94560;
    border-color: #e94560;
    color: #fff;
  }

  .tab-count {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-left: 0.2rem;
  }

  .rating-info {
    margin-bottom: 1.5rem;
    border: 1px solid #0f3460;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .rating-info summary {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    color: #a0a0b8;
    user-select: none;
  }

  .rating-info summary:hover {
    color: #e0e0e0;
  }

  .rating-info-body {
    padding: 0 0.75rem 0.75rem;
    color: #a0a0b8;
    line-height: 1.6;
  }

  .rating-info-body p {
    margin: 0.5rem 0;
  }

  .rating-info-body a {
    color: #e94560;
  }

  .rating-info-body code {
    background: #16213e;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.85em;
  }

  .filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filters input,
  .filters select {
    font-family: inherit;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 4px;
    color: #e0e0e0;
    outline: none;
    transition: border-color 0.2s;
  }

  .filters input {
    flex: 1;
    min-width: 200px;
  }

  .filters select {
    min-width: 160px;
  }

  .filters input:focus,
  .filters select:focus {
    border-color: #e94560;
  }

  .filters input::placeholder {
    color: #a0a0b8;
  }

  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    width: 100%;
    min-width: 620px;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  th {
    text-align: left;
    padding: 0.6rem 0.75rem;
    border-bottom: 2px solid #0f3460;
    color: #a0a0b8;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: color 0.2s;
  }

  th:hover {
    color: #e94560;
  }

  th.sorted {
    color: #e94560;
  }

  .sort-arrow {
    display: inline-block;
    margin-left: 0.35rem;
    font-size: 0.7rem;
    vertical-align: middle;
  }

  td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid rgba(15, 52, 96, 0.5);
  }

  .rank-col {
    cursor: default;
    width: 2rem;
    text-align: center;
  }

  .rank-cell {
    text-align: center;
    color: #a0a0b8;
    font-variant-numeric: tabular-nums;
  }

  .model-name {
    font-weight: 600;
    color: #e0e0e0;
  }

  .num {
    font-variant-numeric: tabular-nums;
    text-align: right;
  }

  .games-link {
    color: #e94560;
    text-decoration: none;
  }

  .games-link:hover {
    text-decoration: underline;
  }

  th[data-sort="rating"],
  th[data-sort="gamesPlayed"],
  th[data-sort="winRate"],
  th[data-sort="avgBlundersPerGame"],
  th[data-sort="avgApiCost"] {
    text-align: right;
  }


  tbody tr {
    transition: background 0.15s;
  }

  tbody tr:nth-child(even) {
    background: rgba(22, 33, 62, 0.3);
  }

  tbody tr:hover {
    background: rgba(233, 69, 96, 0.08);
  }

  .no-results {
    color: #a0a0b8;
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
  }

  .empty-state {
    color: #a0a0b8;
    text-align: center;
    padding: 4rem 0;
    font-size: 1.1rem;
  }

  @media (max-width: 600px) {
    .filters {
      flex-direction: column;
    }

    .filters input,
    .filters select {
      width: 100%;
    }

    th, td {
      padding: 0.5rem;
      font-size: 0.8rem;
    }

    .format-tabs {
      gap: 0.3rem;
    }

    .format-tab {
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
    }
  }
</style>
