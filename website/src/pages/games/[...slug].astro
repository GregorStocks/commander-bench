---
import Base from '../../layouts/Base.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const gamesDir = path.join(process.cwd(), 'public', 'games');
  const indexPath = path.join(gamesDir, 'index.json');
  if (!fs.existsSync(indexPath)) {
    return [];
  }
  const games = JSON.parse(fs.readFileSync(indexPath, 'utf-8'));
  return games.map((g: { id: string }) => ({ params: { slug: g.id } }));
}

const { slug } = Astro.params;
---

<Base title="Game Replay" wide>
  <link rel="stylesheet" href="/game-renderer.css" />
  <div id="visualizer">
    <div id="loading">Loading game data...</div>
    <div id="error" class="hidden"></div>

    <div id="game-ui" class="hidden">
      <!-- Header -->
      <div id="game-header">
        <div id="game-title"></div>
        <div id="turn-info"></div>
      </div>

      <!-- Transport controls -->
      <div id="transport">
        <div class="transport-buttons">
          <button id="btn-start" title="First snapshot">|&lt;</button>
          <button id="btn-prev" title="Previous (Left arrow)">&lt;</button>
          <button id="btn-next" title="Next (Right arrow)">&gt;</button>
          <button id="btn-end" title="Last snapshot">&gt;|</button>
          <button id="btn-auto" title="Auto-play">Play</button>
        </div>
        <div class="turn-nav">
          <button id="btn-prev-turn" title="Previous turn ([)">&lt;T</button>
          <select id="turn-select" title="Jump to turn"></select>
          <button id="btn-next-turn" title="Next turn (])">T&gt;</button>
        </div>
        <input type="range" id="slider" min="0" max="0" value="0" />
        <div id="snapshot-counter"></div>
      </div>

      <!-- Board: 2x2 player grid -->
      <div id="players-grid"></div>

      <!-- Stack -->
      <div id="stack-section" class="hidden">
        <div class="section-title">Stack</div>
        <div id="stack-cards" class="cards-row"></div>
      </div>

      <!-- Action log -->
      <div id="action-log">
        <div class="section-title">Actions</div>
        <div id="action-list"></div>
      </div>

      <!-- Card preview (hover) -->
      <div id="card-preview" class="hidden">
        <img id="preview-image" alt="" />
        <div class="card-meta">
          <div id="preview-name" class="card-name"></div>
          <div id="preview-type" class="card-type"></div>
          <div id="preview-stats" class="card-stats"></div>
          <pre id="preview-rules" class="card-rules"></pre>
        </div>
      </div>
    </div>
  </div>
</Base>

<style>
  #visualizer {
    font-family: system-ui, -apple-system, sans-serif;
  }

  #loading, #error {
    text-align: center;
    padding: 4rem 0;
    color: #a0a0b8;
  }

  #error {
    color: #e94560;
  }

  /* Header */
  #game-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }

  #game-title {
    font-size: 1rem;
    font-weight: 600;
    color: #e94560;
  }

  #turn-info {
    font-size: 0.85rem;
    color: #a0a0b8;
    text-align: right;
  }

  /* Transport */
  #transport {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }

  .transport-buttons {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .transport-buttons button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #1a4a8a;
    border-radius: 4px;
    padding: 0.35rem 0.6rem;
    cursor: pointer;
    font-family: monospace;
    font-size: 0.85rem;
    transition: background 0.15s;
  }

  .transport-buttons button:hover {
    background: #1a4a8a;
  }

  .transport-buttons button.active {
    background: #e94560;
    border-color: #e94560;
    color: #fff;
  }

  .turn-nav {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
    align-items: center;
  }

  .turn-nav button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #1a4a8a;
    border-radius: 4px;
    padding: 0.35rem 0.5rem;
    cursor: pointer;
    font-family: monospace;
    font-size: 0.8rem;
    transition: background 0.15s;
  }

  .turn-nav button:hover {
    background: #1a4a8a;
  }

  #turn-select {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #1a4a8a;
    border-radius: 4px;
    padding: 0.3rem 0.4rem;
    font-family: monospace;
    font-size: 0.8rem;
    cursor: pointer;
  }

  #slider {
    flex: 1;
    min-width: 100px;
    accent-color: #e94560;
  }

  #snapshot-counter {
    font-size: 0.8rem;
    color: #a0a0b8;
    white-space: nowrap;
    min-width: 6rem;
    text-align: right;
  }

  /* Action log */
  #action-log {
    padding: 0.75rem 1rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }

  #action-list {
    max-height: 12rem;
    overflow-y: auto;
    font-size: 0.8rem;
    line-height: 1.5;
  }

  .action-line {
    padding: 0.15rem 0;
    color: #c0c0d0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  }

  .action-line:last-child {
    border-bottom: 0;
  }
</style>

<script is:inline src="/game-renderer.js"></script>
<script is:inline>
  (function () {
    var R = window.GameRenderer;

    var slug = window.location.pathname.replace(/^\/games\//, "").replace(/\/$/, "");
    if (!slug) {
      showError("No game ID in URL.");
      return;
    }

    var loadingEl = document.getElementById("loading");
    var errorEl = document.getElementById("error");
    var gameUI = document.getElementById("game-ui");

    // Transport
    var btnStart = document.getElementById("btn-start");
    var btnPrev = document.getElementById("btn-prev");
    var btnNext = document.getElementById("btn-next");
    var btnEnd = document.getElementById("btn-end");
    var btnAuto = document.getElementById("btn-auto");
    var slider = document.getElementById("slider");
    var counterEl = document.getElementById("snapshot-counter");

    // Display
    var gameTitleEl = document.getElementById("game-title");
    var turnInfoEl = document.getElementById("turn-info");
    var playersGrid = document.getElementById("players-grid");
    var stackSection = document.getElementById("stack-section");
    var stackCards = document.getElementById("stack-cards");
    var actionList = document.getElementById("action-list");

    // Turn navigation
    var turnSelect = document.getElementById("turn-select");
    var btnPrevTurn = document.getElementById("btn-prev-turn");
    var btnNextTurn = document.getElementById("btn-next-turn");

    // Card preview elements
    var previewEls = {
      container: document.getElementById("card-preview"),
      image: document.getElementById("preview-image"),
      name: document.getElementById("preview-name"),
      type: document.getElementById("preview-type"),
      stats: document.getElementById("preview-stats"),
      rules: document.getElementById("preview-rules"),
    };

    var game = null;
    var currentIndex = 0;
    var autoPlayInterval = null;
    var playerColorMap = {};
    var turnStartIndices = [];

    function showError(msg) {
      loadingEl.classList.add("hidden");
      errorEl.textContent = msg;
      errorEl.classList.remove("hidden");
    }

    function escapeHtml(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function colorizePlayerNames(message) {
      var escaped = escapeHtml(message);
      var names = Object.keys(playerColorMap);
      names.sort(function (a, b) { return b.length - a.length; });
      names.forEach(function (name) {
        var cls = "action-" + R.PLAYER_COLORS[playerColorMap[name]];
        var escapedName = escapeHtml(name);
        escaped = escaped.split(escapedName).join('<span class="' + cls + '">' + escapedName + '</span>');
      });
      return escaped;
    }

    function renderSnapshot(index) {
      var snap = game.snapshots[index];
      if (!snap) return;

      // Compute diff against previous snapshot
      var prevSnap = index > 0 ? game.snapshots[index - 1] : null;
      var diffs = R.computeDiff(prevSnap, snap);

      // Turn info
      var phase = snap.phase || "";
      var step = snap.step || "";
      var phaseDisplay = step && step !== phase ? phase + " / " + step : phase;
      turnInfoEl.textContent =
        "Turn " + snap.turn + "/" + game.totalTurns +
        " | " + phaseDisplay +
        " | Active: " + (snap.active_player || "?");

      // Players
      R.renderPlayers(playersGrid, snap.players, {
        cardImages: game.cardImages,
        playerColorMap: playerColorMap,
        diffs: diffs,
        previewEls: previewEls,
      });

      // Stack
      R.renderStack(stackSection, stackCards, snap.stack, game.cardImages, previewEls);

      // Action log: show actions between previous snapshot seq and current snapshot seq
      actionList.innerHTML = "";
      var prevSeq = index > 0 ? game.snapshots[index - 1].seq : 0;
      var curSeq = snap.seq;
      var relevantActions = game.actions.filter(function (a) {
        return a.seq > prevSeq && a.seq <= curSeq;
      });

      if (relevantActions.length === 0) {
        var empty = document.createElement("div");
        empty.className = "action-line";
        empty.textContent = "(no actions)";
        actionList.appendChild(empty);
      } else {
        relevantActions.forEach(function (action) {
          var line = document.createElement("div");
          line.className = "action-line";
          line.innerHTML = colorizePlayerNames(action.message);
          actionList.appendChild(line);
        });
      }

      // Update transport
      slider.value = String(index);
      counterEl.textContent = (index + 1) + " / " + game.snapshots.length;

      // Sync turn dropdown
      if (turnStartIndices.length > 0) {
        var currentTurn = snap.turn;
        for (var ti = turnStartIndices.length - 1; ti >= 0; ti--) {
          if (turnStartIndices[ti].turn <= currentTurn) {
            turnSelect.selectedIndex = ti;
            break;
          }
        }
      }
    }

    function goTo(index) {
      currentIndex = Math.max(0, Math.min(index, game.snapshots.length - 1));
      renderSnapshot(currentIndex);
    }

    function toggleAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
        btnAuto.textContent = "Play";
        btnAuto.classList.remove("active");
      } else {
        btnAuto.textContent = "Pause";
        btnAuto.classList.add("active");
        autoPlayInterval = setInterval(function () {
          if (currentIndex >= game.snapshots.length - 1) {
            toggleAutoPlay();
            return;
          }
          goTo(currentIndex + 1);
        }, 500);
      }
    }

    // Load game data
    fetch("/games/" + slug + ".json")
      .then(function (r) {
        if (!r.ok) throw new Error("Game not found (HTTP " + r.status + ")");
        return r.json();
      })
      .then(function (data) {
        game = data;

        if (!game.snapshots || game.snapshots.length === 0) {
          showError("No snapshots in game data.");
          return;
        }

        // Show UI
        loadingEl.classList.add("hidden");
        gameUI.classList.remove("hidden");

        // Build player color map
        (game.players || []).forEach(function (p, i) {
          playerColorMap[p.name] = i % 4;
        });

        // Build turn start indices
        var lastTurn = -1;
        game.snapshots.forEach(function (snap, i) {
          if (snap.turn !== lastTurn) {
            turnStartIndices.push({ turn: snap.turn, index: i });
            lastTurn = snap.turn;
          }
        });

        // Populate turn dropdown
        turnStartIndices.forEach(function (t) {
          var opt = document.createElement("option");
          opt.value = String(t.index);
          opt.textContent = "Turn " + t.turn;
          turnSelect.appendChild(opt);
        });

        // Title
        var playerNames = (game.players || []).map(function (p) {
          return p.commander || p.name;
        }).join(" vs ");
        gameTitleEl.textContent = playerNames;

        // Set up transport
        slider.max = String(game.snapshots.length - 1);

        btnStart.addEventListener("click", function () { goTo(0); });
        btnPrev.addEventListener("click", function () { goTo(currentIndex - 1); });
        btnNext.addEventListener("click", function () { goTo(currentIndex + 1); });
        btnEnd.addEventListener("click", function () { goTo(game.snapshots.length - 1); });
        btnAuto.addEventListener("click", toggleAutoPlay);
        slider.addEventListener("input", function () { goTo(Number(slider.value)); });

        // Turn navigation
        turnSelect.addEventListener("change", function () { goTo(Number(turnSelect.value)); });
        btnPrevTurn.addEventListener("click", function () {
          var idx = Math.max(0, turnSelect.selectedIndex - 1);
          turnSelect.selectedIndex = idx;
          goTo(Number(turnSelect.value));
        });
        btnNextTurn.addEventListener("click", function () {
          var idx = Math.min(turnStartIndices.length - 1, turnSelect.selectedIndex + 1);
          turnSelect.selectedIndex = idx;
          goTo(Number(turnSelect.value));
        });

        document.addEventListener("keydown", function (e) {
          if (e.key === "ArrowRight") { e.preventDefault(); goTo(currentIndex + 1); }
          if (e.key === "ArrowLeft") { e.preventDefault(); goTo(currentIndex - 1); }
          if (e.key === "Home") { e.preventDefault(); goTo(0); }
          if (e.key === "End") { e.preventDefault(); goTo(game.snapshots.length - 1); }
          if (e.key === " ") { e.preventDefault(); toggleAutoPlay(); }
          if (e.key === "Escape") { R.hidePreview(previewEls); }
          if (e.key === "[") { e.preventDefault(); btnPrevTurn.click(); }
          if (e.key === "]") { e.preventDefault(); btnNextTurn.click(); }
        });

        // Render first snapshot
        renderSnapshot(0);
      })
      .catch(function (err) {
        showError(err.message || "Failed to load game data.");
      });

    window.addEventListener("blur", function () { R.hidePreview(previewEls); });
  })();
</script>
