---
import Base from '../../layouts/Base.astro';
import fs from 'node:fs';
import path from 'node:path';
import zlib from 'node:zlib';

const gamesDir = path.join(process.cwd(), 'public', 'games');
const games: Array<Record<string, unknown>> = [];
if (fs.existsSync(gamesDir)) {
  for (const file of fs.readdirSync(gamesDir)) {
    if (!file.startsWith('game_') || !file.endsWith('.json.gz')) continue;
    const compressed = fs.readFileSync(path.join(gamesDir, file));
    const data = JSON.parse(zlib.gunzipSync(compressed).toString());
    const players = data.players || [];
    // Compute tool call counts from llmEvents if not already on players
    if (players.length > 0 && !players.some((p: any) => p.toolCallsOk != null)) {
      const toolOk: Record<string, number> = {};
      const toolFailed: Record<string, number> = {};
      for (const ev of (data.llmEvents || [])) {
        if (ev.type !== 'tool_call' || !ev.player) continue;
        let isFail = false;
        if (ev.result) {
          try {
            const r = JSON.parse(ev.result);
            if (r && typeof r === 'object' && r.success === false) isFail = true;
          } catch {}
        }
        if (isFail) toolFailed[ev.player] = (toolFailed[ev.player] || 0) + 1;
        else toolOk[ev.player] = (toolOk[ev.player] || 0) + 1;
      }
      for (const p of players) {
        if (toolOk[p.name] != null || toolFailed[p.name] != null) {
          p.toolCallsOk = toolOk[p.name] || 0;
          p.toolCallsFailed = toolFailed[p.name] || 0;
        }
      }
    }
    const entry: Record<string, unknown> = {
      id: data.id,
      timestamp: data.timestamp,
      totalTurns: data.totalTurns,
      winner: data.winner,
      players: players,
      deckType: data.deckType || '',
    };
    if (data.youtubeUrl) entry.youtubeUrl = data.youtubeUrl;
    games.push(entry);
  }
}
games.sort((a, b) => String(b.id).localeCompare(String(a.id)));
---

<Base title="Games">
  <h1>Games</h1>
  <p class="subtitle">Replay past mage-bench games.</p>
  <div id="filter-bar" style="display:none"></div>
  <div id="games-list">
    <p class="loading">Loading games...</p>
  </div>
</Base>

<style>
  h1 {
    color: #e94560;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: #a0a0b8;
    margin-bottom: 2rem;
  }

  .loading {
    color: #a0a0b8;
  }
</style>

<style is:global>
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-label {
    color: #a0a0b8;
    font-size: 0.85rem;
  }

  .filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-family: inherit;
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    background: rgba(233, 69, 96, 0.15);
    border: 1px solid #e94560;
    border-radius: 20px;
    color: #e94560;
  }

  .filter-chip-remove {
    background: none;
    border: none;
    color: #e94560;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 0;
    opacity: 0.7;
  }

  .filter-chip-remove:hover {
    opacity: 1;
  }

  .filter-clear {
    background: none;
    border: none;
    color: #a0a0b8;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.8rem;
    padding: 0.3rem 0.5rem;
  }

  .filter-clear:hover {
    color: #e0e0e0;
  }

  .filter-count {
    color: #a0a0b8;
    font-size: 0.85rem;
    margin-left: auto;
  }
</style>

<style is:global>
  .no-games {
    color: #a0a0b8;
    font-style: italic;
  }

  .game-card {
    display: block;
    margin-bottom: 1rem;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    text-decoration: none;
    color: #e0e0e0;
    transition: border-color 0.2s;
    overflow: hidden;
  }

  .game-card:hover {
    border-color: #e94560;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 1rem;
    background: rgba(15, 52, 96, 0.3);
    border-bottom: 1px solid rgba(15, 52, 96, 0.5);
    font-size: 0.85rem;
  }

  .game-date {
    color: #a0a0b8;
  }

  .format-badge {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    letter-spacing: 0.03em;
  }

  .format-standard {
    background: rgba(76, 175, 80, 0.15);
    color: #66bb6a;
  }

  .format-modern {
    background: rgba(33, 150, 243, 0.15);
    color: #42a5f5;
  }

  .format-legacy {
    background: rgba(156, 39, 176, 0.15);
    color: #ab47bc;
  }

  .format-commander {
    background: rgba(255, 152, 0, 0.15);
    color: #ffa726;
  }

  .game-turns {
    color: #a0a0b8;
  }

  .game-winner {
    font-weight: 600;
  }

  .winner-none {
    color: #a0a0b8;
    font-style: italic;
  }

  .winner-found {
    color: #a8d9a5;
  }

  .yt-link {
    color: #e94560;
    text-decoration: none;
    font-size: 0.75rem;
    margin-left: 0.5rem;
  }

  .yt-link:hover {
    text-decoration: underline;
  }

  .game-players {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }

  .player-cell {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    border-right: 1px solid rgba(15, 52, 96, 0.3);
  }

  .player-cell:nth-child(2n) {
    border-right: none;
  }

  .player-cell:nth-child(n+3) {
    border-bottom: none;
  }

  .player-cell.is-winner {
    box-shadow: inset 3px 0 0 #a8d9a5;
  }

  .player-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.15rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .player-badge {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    letter-spacing: 0.03em;
    flex-shrink: 0;
  }

  .badge-pilot {
    background: rgba(233, 69, 96, 0.2);
    color: #e94560;
  }

  .badge-cpu {
    background: rgba(160, 160, 184, 0.15);
    color: #a0a0b8;
  }

  .player-commander {
    font-size: 0.8rem;
    color: #a0a0b8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .player-model {
    font-size: 0.75rem;
    color: #e94560;
    opacity: 0.8;
  }

  .player-cost {
    font-size: 0.75rem;
    color: #a0a0b8;
    font-variant-numeric: tabular-nums;
  }

  .player-tools {
    font-size: 0.75rem;
    color: #a0a0b8;
    font-variant-numeric: tabular-nums;
  }

  .tool-fail {
    color: #e94560;
  }

  .player-elo {
    font-size: 0.75rem;
    color: #a0a0b8;
    font-variant-numeric: tabular-nums;
  }

  .player-elo.elo-up {
    color: #a8d9a5;
  }

  .player-elo.elo-down {
    color: #e94560;
  }

  .game-footer {
    padding: 0.4rem 1rem;
    font-size: 0.8rem;
    color: #a0a0b8;
    text-align: right;
    border-top: 1px solid rgba(15, 52, 96, 0.5);
    font-variant-numeric: tabular-nums;
  }

  @media (max-width: 500px) {
    .game-players {
      grid-template-columns: 1fr;
    }

    .player-cell:nth-child(2n) {
      border-right: none;
    }

    .player-cell {
      border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    }

    .player-cell:last-child {
      border-bottom: none;
    }

    .game-header {
      flex-wrap: wrap;
      gap: 0.25rem;
    }
  }
</style>

<script is:inline define:vars={{ games }}>
  var __games = games;

  var DECK_TYPE_FORMATS = {
    "Constructed - Standard": "standard",
    "Constructed - Modern": "modern",
    "Constructed - Legacy": "legacy",
    "Variant Magic - Freeform Commander": "commander",
    "Variant Magic - Commander": "commander",
  };

  var FORMAT_DISPLAY = {
    "standard": "Standard",
    "modern": "Modern",
    "legacy": "Legacy",
    "commander": "Commander",
  };

  function getGameFormat(deckType) {
    return DECK_TYPE_FORMATS[deckType] || "commander";
  }

  function getFilters() {
    var params = new URLSearchParams(window.location.search);
    return {
      model: params.get("model") || "",
      format: params.get("format") || "",
    };
  }

  function setFilters(filters) {
    var params = new URLSearchParams();
    if (filters.model) params.set("model", filters.model);
    if (filters.format) params.set("format", filters.format);
    var qs = params.toString();
    var url = window.location.pathname + (qs ? "?" + qs : "");
    history.replaceState(null, "", url);
  }

  function filterGames(games, filters) {
    return games.filter(function (game) {
      if (filters.format) {
        var fmt = getGameFormat(game.deckType);
        if (fmt !== filters.format) return false;
      }
      if (filters.model) {
        var hasModel = (game.players || []).some(function (p) {
          return p.model === filters.model;
        });
        if (!hasModel) return false;
      }
      return true;
    });
  }

  function renderFilterBar(filters, totalCount, filteredCount) {
    var bar = document.getElementById("filter-bar");
    var hasFilters = filters.model || filters.format;
    if (!hasFilters) {
      bar.style.display = "none";
      bar.innerHTML = "";
      return;
    }
    bar.style.display = "";
    bar.className = "filter-bar";
    bar.innerHTML = "";

    var label = document.createElement("span");
    label.className = "filter-label";
    label.textContent = "Filtered:";
    bar.appendChild(label);

    if (filters.format) {
      var chip = document.createElement("span");
      chip.className = "filter-chip";
      chip.textContent = FORMAT_DISPLAY[filters.format] || filters.format;
      var btn = document.createElement("button");
      btn.className = "filter-chip-remove";
      btn.innerHTML = "&times;";
      btn.onclick = function () {
        var f = getFilters();
        f.format = "";
        setFilters(f);
        renderAll();
      };
      chip.appendChild(btn);
      bar.appendChild(chip);
    }

    if (filters.model) {
      var chip = document.createElement("span");
      chip.className = "filter-chip";
      var modelDisplay = filters.model;
      var slash = modelDisplay.indexOf("/");
      if (slash !== -1) modelDisplay = modelDisplay.substring(slash + 1);
      chip.textContent = modelDisplay;
      var btn = document.createElement("button");
      btn.className = "filter-chip-remove";
      btn.innerHTML = "&times;";
      btn.onclick = function () {
        var f = getFilters();
        f.model = "";
        setFilters(f);
        renderAll();
      };
      chip.appendChild(btn);
      bar.appendChild(chip);
    }

    if (filters.model && filters.format) {
      var clear = document.createElement("button");
      clear.className = "filter-clear";
      clear.textContent = "Clear all";
      clear.onclick = function () {
        setFilters({ model: "", format: "" });
        renderAll();
      };
      bar.appendChild(clear);
    }

    var count = document.createElement("span");
    count.className = "filter-count";
    count.textContent = filteredCount + " of " + totalCount + " games";
    bar.appendChild(count);
  }

  function renderGameCard(game, eloData) {
    var a = document.createElement("a");
    a.href = "/games/" + game.id;
    a.className = "game-card";

    // Parse timestamp: "20260210_090609" -> human-readable date
    var ts = game.timestamp || "";
    var dateStr = "";
    if (ts.length >= 15) {
      var year = ts.substring(0, 4);
      var month = ts.substring(4, 6);
      var day = ts.substring(6, 8);
      var hour = ts.substring(9, 11);
      var min = ts.substring(11, 13);
      var d = new Date(year + "-" + month + "-" + day + "T" + hour + ":" + min);
      if (!isNaN(d.getTime())) {
        dateStr = d.toLocaleDateString("en-US", {
          year: "numeric", month: "short", day: "numeric"
        }) + " " + d.toLocaleTimeString("en-US", {
          hour: "numeric", minute: "2-digit"
        });
      }
    }

    // Header
    var header = document.createElement("div");
    header.className = "game-header";

    var dateEl = document.createElement("span");
    dateEl.className = "game-date";
    dateEl.textContent = dateStr || game.id;
    header.appendChild(dateEl);

    // Format badge
    var formatKey = getGameFormat(game.deckType);
    var formatLabel = FORMAT_DISPLAY[formatKey] || "Commander";
    var fmtBadge = document.createElement("span");
    fmtBadge.className = "format-badge format-" + formatLabel.toLowerCase();
    fmtBadge.textContent = formatLabel;
    header.appendChild(fmtBadge);

    var turnsEl = document.createElement("span");
    turnsEl.className = "game-turns";
    turnsEl.textContent = game.totalTurns + " turns";
    header.appendChild(turnsEl);

    var winnerEl = document.createElement("span");
    if (game.winner) {
      winnerEl.className = "game-winner winner-found";
      winnerEl.textContent = "\u2605 " + game.winner;
    } else {
      winnerEl.className = "game-winner winner-none";
      winnerEl.textContent = "No winner";
    }
    header.appendChild(winnerEl);

    a.appendChild(header);

    // Player grid
    var grid = document.createElement("div");
    grid.className = "game-players";

    var totalCost = 0;
    var hasCost = false;

    (game.players || []).forEach(function (p) {
      var cell = document.createElement("div");
      cell.className = "player-cell";
      if (game.winner && p.name === game.winner) {
        cell.classList.add("is-winner");
      }

      // Name + badge
      var nameRow = document.createElement("div");
      nameRow.className = "player-name";

      var badge = document.createElement("span");
      badge.className = "player-badge " + (p.type === "pilot" ? "badge-pilot" : "badge-cpu");
      badge.textContent = p.type === "pilot" ? "AI" : "CPU";
      nameRow.appendChild(badge);

      var nameText = document.createTextNode(p.name);
      nameRow.appendChild(nameText);
      cell.appendChild(nameRow);

      // Commander
      var cmdEl = document.createElement("div");
      cmdEl.className = "player-commander";
      cmdEl.textContent = p.deckName || p.commander || "";
      cell.appendChild(cmdEl);

      // Model (only for pilots)
      if (p.model) {
        var modelEl = document.createElement("div");
        modelEl.className = "player-model";
        var modelName = p.model;
        var slash = modelName.indexOf("/");
        if (slash !== -1) modelName = modelName.substring(slash + 1);
        modelEl.textContent = modelName;
        cell.appendChild(modelEl);
      }

      // Cost (only if present)
      if (p.totalCostUsd != null) {
        var costEl = document.createElement("div");
        costEl.className = "player-cost";
        costEl.textContent = "$" + p.totalCostUsd.toFixed(2);
        cell.appendChild(costEl);
        totalCost += p.totalCostUsd;
        hasCost = true;
      }

      // Tool calls (only if present)
      if (p.toolCallsOk != null) {
        var toolsEl = document.createElement("div");
        toolsEl.className = "player-tools";
        var total = p.toolCallsOk + (p.toolCallsFailed || 0);
        var text = total + " tools";
        if (p.toolCallsFailed > 0) {
          toolsEl.innerHTML = text + " / <span class=\"tool-fail\">" + p.toolCallsFailed + " failed</span>";
        } else {
          toolsEl.textContent = text;
        }
        cell.appendChild(toolsEl);
      }

      // Elo (if available)
      var gameElo = eloData[game.id];
      var playerElo = gameElo && p.model ? gameElo[p.model] : null;
      if (playerElo) {
        var eloEl = document.createElement("div");
        eloEl.className = "player-elo";
        var delta = playerElo.after - playerElo.before;
        if (delta > 0) eloEl.classList.add("elo-up");
        else if (delta < 0) eloEl.classList.add("elo-down");
        eloEl.textContent = playerElo.before + " \u2192 " + playerElo.after;
        cell.appendChild(eloEl);
      }

      grid.appendChild(cell);
    });

    a.appendChild(grid);

    // Footer with total cost (only if there's cost data)
    if (hasCost) {
      var footer = document.createElement("div");
      footer.className = "game-footer";
      footer.textContent = "Total cost: $" + totalCost.toFixed(2);
      a.appendChild(footer);
    }
    // YouTube link in footer
    if (game.youtubeUrl) {
      var ytLink = document.createElement("a");
      ytLink.href = game.youtubeUrl;
      ytLink.target = "_blank";
      ytLink.rel = "noopener";
      ytLink.className = "yt-link";
      ytLink.textContent = "YouTube";
      ytLink.onclick = function (e) { e.stopPropagation(); };
      var footerEl = a.querySelector(".game-footer");
      if (footerEl) {
        footerEl.appendChild(ytLink);
      } else {
        var ytFooter = document.createElement("div");
        ytFooter.className = "game-footer";
        ytFooter.appendChild(ytLink);
        a.appendChild(ytFooter);
      }
    }

    return a;
  }

  var __eloData = {};

  function renderAll() {
    var games = __games;
    var eloData = __eloData;
    var list = document.getElementById("games-list");
    list.innerHTML = "";

    if (!games || games.length === 0) {
      renderFilterBar({ model: "", format: "" }, 0, 0);
      list.innerHTML = '<p class="no-games">No games exported yet.</p>';
      return;
    }

    var filters = getFilters();
    var filtered = filterGames(games, filters);
    renderFilterBar(filters, games.length, filtered.length);

    if (filtered.length === 0) {
      list.innerHTML = '<p class="no-games">No games match the current filters.</p>';
      return;
    }

    filtered.forEach(function (game) {
      list.appendChild(renderGameCard(game, eloData));
    });
  }

  fetch("/data/elo.json").then(function (r) {
    return r.ok ? r.json() : {};
  }).catch(function () { return {}; })
    .then(function (eloData) {
      __eloData = eloData;
      renderAll();
    })
    .catch(function () {
      var list = document.getElementById("games-list");
      list.innerHTML = '<p class="no-games">No games exported yet.</p>';
    });
</script>
